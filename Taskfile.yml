version: "3"

tasks:
  # General check for mindless complete verification
  check:
    cmds:
      - task fmt
      - task test
      - task lint

  # Formating
  fmt:
    cmds:
      - task fmt_endpoint
      - task fmt_idl
      - task fmt_anchor

  # Testing
  test:
    cmds:
      - task test_endpoint
      - task test_idl
      - task test_anchor

  # Linting (clippy)
  lint:
    cmds:
      - task lint_endpoint
      - task lint_idl
      - task lint_anchor

  # Sub-crate Endpoint
  fmt_endpoint:
    dir: "{{ .TASKFILE_DIR }}/solana_toolbox_endpoint"
    cmds:
      - cargo +nightly fmt
  test_endpoint:
    dir: "{{ .TASKFILE_DIR }}/solana_toolbox_endpoint"
    cmds:
      - cp Cargo-solana-1.18.26.toml Cargo.toml
      - cargo test {{ .CLI_ARGS }}
      - cp Cargo-solana-2.1.4.toml Cargo.toml
      - cargo test {{ .CLI_ARGS }}
  lint_endpoint:
    dir: "{{ .TASKFILE_DIR }}/solana_toolbox_endpoint"
    cmds:
      - cp Cargo-solana-1.18.26.toml Cargo.toml
      - cargo +nightly clippy --all-targets --all-features -- -D warnings
      - cp Cargo-solana-2.1.4.toml Cargo.toml
      - cargo +nightly clippy --all-targets --all-features -- -D warnings

  # Sub-crate IDL
  fmt_idl:
    dir: "{{ .TASKFILE_DIR }}/solana_toolbox_idl"
    cmds:
      - cargo +nightly fmt
  test_idl:
    dir: "{{ .TASKFILE_DIR }}/solana_toolbox_idl"
    cmds:
      - cp Cargo-solana-1.18.26.toml Cargo.toml
      - cargo test {{ .CLI_ARGS }}
      - cp Cargo-solana-2.1.4.toml Cargo.toml
      - cargo test {{ .CLI_ARGS }}
  lint_idl:
    dir: "{{ .TASKFILE_DIR }}/solana_toolbox_idl"
    cmds:
      - cp Cargo-solana-1.18.26.toml Cargo.toml
      - cargo +nightly clippy --all-targets --all-features -- -D warnings
      - cp Cargo-solana-2.1.4.toml Cargo.toml
      - cargo +nightly clippy --all-targets --all-features -- -D warnings

  # Sub-crate Anchor
  fmt_anchor:
    dir: "{{ .TASKFILE_DIR }}/solana_toolbox_anchor"
    cmds:
      - cargo +nightly fmt
  test_anchor:
    dir: "{{ .TASKFILE_DIR }}/solana_toolbox_anchor"
    cmds:
      - cp Cargo-solana-1.18.26-anchor-0.30.1.toml Cargo.toml
      - cargo test {{ .CLI_ARGS }}
  lint_anchor:
    dir: "{{ .TASKFILE_DIR }}/solana_toolbox_anchor"
    cmds:
      - cp Cargo-solana-1.18.26-anchor-0.30.1.toml Cargo.toml
      - cargo +nightly clippy --all-targets --all-features -- -D warnings

  # Publish
  publish_endpoint:
    dir: "{{ .TASKFILE_DIR }}/solana_toolbox_endpoint"
    cmds:
      - cp Cargo-solana-1.18.26.toml Cargo.toml
      - cargo test
      - cargo +nightly clippy --all-targets --all-features -- -D warnings
      - git add Cargo.toml
      - git add Cargo.lock
      - git commit -m "publish-endpoint-1.18.26" --allow-empty
      - cargo publish
      - cp Cargo-solana-2.1.4.toml Cargo.toml
      - cargo test
      - cargo +nightly clippy --all-targets --all-features -- -D warnings
      - git add Cargo.toml
      - git add Cargo.lock
      - git commit -m "publish-endpoint-2.1.4" --allow-empty
      - cargo publish
  publish_idl:
    dir: "{{ .TASKFILE_DIR }}/solana_toolbox_idl"
    cmds:
      - cp Cargo-solana-1.18.26.toml Cargo.toml
      - cargo test
      - cargo +nightly clippy --all-targets --all-features -- -D warnings
      - git add Cargo.toml
      - git add Cargo.lock
      - git commit -m "publish-idl-1.18.26" --allow-empty
      - cargo publish
      - cp Cargo-solana-2.1.4.toml Cargo.toml
      - cargo test
      - cargo +nightly clippy --all-targets --all-features -- -D warnings
      - git add Cargo.toml
      - git add Cargo.lock
      - git commit -m "publish-idl-2.1.4" --allow-empty
      - cargo publish
  publish_anchor:
    dir: "{{ .TASKFILE_DIR }}/solana_toolbox_anchor"
    cmds:
      - cp Cargo-solana-1.18.26-anchor-0.30.1.toml Cargo.toml
      - cargo test
      - cargo +nightly clippy --all-targets --all-features -- -D warnings
      - git add Cargo.toml
      - git add Cargo.lock
      - git commit -m "publish-anchor" --allow-empty
      - cargo publish
  publish:
    cmds:
      - task publish_endpoint
      - task publish_idl
      - task publish_anchor
